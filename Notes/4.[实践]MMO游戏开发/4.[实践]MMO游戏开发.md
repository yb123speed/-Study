# 4.[实践]MMO游戏开发

## 4.1网络游戏开发的基础流程

## 4.2C/S MMO游戏的发展趋势和对策

C/S MMO特有的游戏内容：

- 处理大量数据
- 向玩家严格保密设定信息
- 严格维护游戏数据的更改内容
- 简单地进行设定信息的更改
- 易于结合SNS等其他服务系统

C/S MMO架构的限制：

- 延迟较大
- 游戏服务器的带宽负荷很高
- 游戏服务器的维护费用很高
- 服务器停止期间，无法进行游戏

## 4.3策划文档和5种设计文档

## 4.4系统基本结构图的制定

### 专栏——MMO客户端特有的渲染性能瓶颈

游戏客户端的瓶颈：游戏处理和渲染处理

渲染的处理速度在不同阶段中有锁不同：

- 从磁盘读取数据至主存中：非常缓慢。所需的时间以毫秒为单位。
- 从主存读取数据至GPU的内存中：较慢。所有的时间以微秒为单位。
- GPU内存内部的传输：非常快。完成时间以纳秒为单位。

因此，在GPU内部进行处理才能达到高速渲染。

一般游戏中的渲染尽可能全都在GPU中加载，之后在游戏过程中，所有内容的读取都尽量不要访问主存和磁盘。这一点是最基本的。

MMO中的渲染——玩家角色

- 不要“一口气读取所有必要的数据”，而是在保持帧速率的情况下花时间一点点读取。
- 即使是在读取纹理数据的过程中，也尽量只先进行轮廓的渲染，只对所处位置有所了解。

### 解决游戏服务器/数据库的瓶颈

解决服务器的瓶颈主要有以下两种方法：

1. 空间分割法（空间地理上的分割）

    根据地理结构将游戏世界进行分割，分割给其他的服务器进程或服务器设备进行处理。

2. 实例法（游戏副本实例）

    将负荷特别高的、用户集中在一起的部分独立出来，将这些部分分配给专用的服务器来处理。这些部分未必都是以游戏副本的形式来呈现，但典型情况下都是使用这种形式的，所以也称为游戏副本实例（instance dungeon）。

3. 平行世界方式

    使容易成为瓶颈的数据库本身并行化，以此将瓶颈分为多个。但是保存了玩家信息的数据库分成多个后，角色就无法在不同的世界之间移动，所以玩家之间的交流也被切断了。

上述3种方式也可以同时使用。WOW中就同时使用了上述3种方法，从而支持数百万玩家参与游戏。

#### K Online的设计估算——首先从同时在线开始

瓶颈的确认：

1. 客户端渲染性能的瓶颈
2. 用户侧线路带宽的瓶颈
3. 游戏服务器的逻辑处理性能的瓶颈
4. 游戏数据库写入性能的瓶颈

#### 服务器的基本结构

1. 收费认证服务器是通用的
2. 分割为5个平行时间，1个世界允许同时在线6000人，总共3w人同时访问
3. 1个世界分为8个地区（8核）
4. 1个世界准备360个实例
5. 玩家继续增加的情况下，追加平行世界

![进程关系图](https://raw.githubusercontent.com/yb123speed/The-core-technology-and-actual-combat-of-network-games-Study/master/Notes/Images/servers0x01.jpg)

### 协议定义文档

协议的实现原则

- 后端实现基本的、通用的功能，前端实现专用功能
- 前端依赖于后端的结构
- 协议是无状态和简单操作的集合
- 在一个地方接受外部的异常状况
- 优秀的API的调用时序
- 有必要推送（Push）吗

#### 8种协议的功能/形式概述

“通知”反映了只调用，没有返回值的单向时序图。

“请求”反映了调用1次，期待返回1次的“三角状时序图”。

------------------------------

##### gmsv协议

gmsv协议负责执行管理敌人的行动、事件、角色升级、作弊行为检测等的游戏逻辑。

gmsv针对cli实现的API大致分为以下3种。

- 来自cli的通知
  - 典型示例：使用鼠标移动角色时；立即发出的移动通知API。
- 来自cli的请求
  - 典型示例：打开物品栏，获取当前所持物品列表的API。
- 来自gmsv的通知
  - 典型示例：敌人的行为。即使cli没有发送任何指示，gmsv仍然要每秒发送数次通知。

------------------------------

##### loginsv协议

loginsv是游戏客户端（cli）登录游戏时最先连接的服务器。负责服务整体使用情况的管理、负荷控制以及会话密钥的分配等。

loginsv对cli提供的API只有从cli对loginsv发出请求，包括密码验证，以及查询能够使用的gmsv列表。

------------------------------

##### msgsv协议

msgsv是用于使聊天、即时消息、公会等社交活动能够跨越平行世界和空间分割来进行消息交换的服务器。

msgsv针对cli实现的API与gmsv一样，大致分为以下3种。

- 来自cli的通知
  - 典型示例：聊天输入。msgsv接收到该消息后，就向其他玩家发出通知。好友的添加也是如此。
- 来自cli的请求
  - 典型示例：获取好友列表。
- 来自msgsv的通知
  - 典型示例：好友登录时发送的上线通知。作为聊天输入的结果而发送的来自其他玩家的聊天消息也对应这一点。

------------------------------

##### dbsv协议

对DBMS进行统一的连接，在一部访问数据库时，实现必要的负荷降低处理。

将DBMS中各个表的CRUD操作作为API来提供。虽然从gmsv、loginsv、msgsv等前端服务器进行访问，但只有以下两点**不从**dbsv推送数据。

- 来自前端服务器的通知
  - 典型示例：玩家角色的保存。保存是绝对必要的，一旦保存失败就意味着gmsv需要强制终止，所以不需要返回值。
- 来自前端服务器的查询
  - 典型示例：玩家角色的加载。

------------------------------

##### worldsv协议

使用空间分割时，属于世界的所有gmsv都连接到这个服务器进程上，复制为各个世界提供通用处理。在K Online中，用来实现“显示世界地图（用来指示玩家处于游戏世界的哪个位置）”的功能。具体有以下两点，不从worldsv推送。

- 来自gmsv的通知
  - 典型示例：保存所有在线玩家的坐标。
- 来自gmsv的请求
  - 典型示例：获取包括其他gmsv在内的所有玩家的坐标。

worldsv不需要对坐标信息进行持久化，所以不使用DBMS。

------------------------------

##### commondbsv协议

在使用平行方式的情况下，对所有的世界共同需要的信息进行持久化。在K Online中需要保存用户ID、密码信息，以及好友列表信息。这些都是与世界无关的而又必要的信息。所有的gmsv、loginsv、msgsv连接至该服务器。

提供的API有以下两种，不推送。

- 来自gmsv的通知
  - 典型示例：通知指定的gmsv中当前有多少人在线。
- 来自gmsv、loginsv、msgsv的请求
  - 典型示例：获取各个gmsv中当前在线的总数。

不使用平行世界方式时，不需要commondbsv，这种情况下commondbsv的所有功能都由dbsv来实现。

------------------------------

##### authsv协议

authsv调用结算公司所提供的API（大多数是Perl和C语言编写的程序库），相当于结算公司之间的网关。

K Online采用“每月定额计费”的方式，提供的API只有“来自loginsv的请求”，其内容只有“获取是否成功收取了某个玩家上个月的费用”，不推送。

------------------------------

##### logsv协议

通过TCP收集整个游戏服务中的日志，根据时间顺序来罗列，保存在文件中，用于进行循环检索等处理。提供的API是“各服务器的日志写入”，只有单方向的通知，所以没有请求、推送。

------------------------------

### 数据包的格式

## 数据库设计图

K Online中需要持久化的信息
![K Online中需要持久化的信息](https://raw.githubusercontent.com/yb123speed/The-core-technology-and-actual-combat-of-network-games-Study/master/Notes/Images/db0x01.jpg)

需要持久化的数据的包含关系
![需要持久化的数据的包含关系](https://raw.githubusercontent.com/yb123speed/The-core-technology-and-actual-combat-of-network-games-Study/master/Notes/Images/db0x02.jpg)

------------------------------

## 服务器/客户端软件+中间件

### 网络游戏的中间件

- 全功能型中间件
- 小规模型MMOG中间件
- 通信中间件

### 开发的基础软件

服务器相关的软件

- Linux
- MySQL
- OpenSSL
- GCC
- 轻量级语言

客户端相关的软件

- DirectX
- WinSock
- Visual Studio .Net
- OpenSSL

## 程序开发中的基本原则

- 数据结构优先原则
- 维持可玩状态原则
- 后端服务器延后原则
- 持续测定原则

## C/S MMO游戏K Online的实现

### 开发的安排

1. 框架阶段
2. 原型阶段
3. 整体框架的实现阶段
4. 量产阶段
5. 收尾阶段
6. 运营开始后的阶段

### 以怎样的顺序来编写代码

### 首先编写协议定义文件K.xml

### 协议定义的要点

### 通信连通确认：ping函数

### 账号登录和账号认证：signup函数、authentication函数

### 角色创建：createCharacter函数

### 登录：login函数

### 在地面上移动：move函数、moveNotify

### 编写gmsv/Makefile

### 从示例中复制gmsv/climain.cpp和gmsvmain.cpp

## 专栏 dbsv服务器代码的自动生成
